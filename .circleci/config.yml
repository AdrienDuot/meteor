version: 2.1
orbs:
    node: circleci/node@1.1
jobs:
    prepare:
        executor:
            name: node/default
            tag: '10.4'
        steps:
        - checkout
        - run: bash <(curl -s https://install.meteor.com)
        - run: npm install
        - run: npm i --save-dev puppeteer@^1.5.0
        - run: mkdir /tmp/artifacts
        - run:
            name: execute meteor test client
            command: TEST_BROWSER_DRIVER=puppeteer meteor test --once --driver-package meteortesting:mocha > /tmp/client
            when: always
        - run:
            name: execute meteor test server
            command: MOCHA_REPORTER=xunit SERVER_MOCHA_OUTPUT=/tmp/artifacts/unit_server.xml meteor test --once --driver-package meteortesting:mocha > /dev/null
            when: always
        
    save:
        executor:
            name: node/default
            tag: '10.4'
        steps:
            - checkout
            - run:
                name: purify console output
                command: ./create_client.sh /tmp/client /tmp/artifacts/unit_server.xml
            - store_test_results:
                path: /tmp/artifacts
            - store_artifacts:
                path: /tmp/artifacts 
        
workflows:
    version: 2.1
    build:
        jobs:
            - prepare
            - save:
                requires:
                    - prepare

